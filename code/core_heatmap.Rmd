---
title: "Persistor OTUs in the incubation experiment"
output: html_notebook
---
# Persistor   
`Persistor: OTUs detected in day 7 soils that persist into early or early and late groups of each treatment group`    
Create a list of OTUs that make up the core taxa from reference soils. Let's create a core list for day 0, 0-97(all days), early and late groups. We will end up with four lists of OTUs for each grouping.

```{r}
library(phyloseq)
library(vegan)
library(tidyverse)
library(gplots)
library(DESeq2)

inc.physeq <- readRDS("data/RDS/incubation_physeq_Aug18.RDS")

#Rename treatments to more informative titles
data <- data.frame(sample_data(inc.physeq)) %>%
  mutate(treatment = recode(treatment,
                            'Control' = 'Reference',
                            'CompAlfa' = 'Mix')) %>%
  mutate(C_N = C_flash / N_flash, Inorganic_N = NH3 + NO3) %>%
  mutate(TreatmentAndDay = paste(treatment, day))
rownames(data) <- data$i_id
sample_data(inc.physeq) <- data
sample_data(inc.physeq)$day <- as.factor(sample_data(inc.physeq)$day)
sample_data(inc.physeq)

inc.physeq.data <- data.frame(sample_data(inc.physeq))
inc.physeq.data$response.group[inc.physeq.data$day == "0"] <- "baseline" 
inc.physeq.data$response.group[inc.physeq.data$day %in% c("7", "14", "21")] <- "early" 
inc.physeq.data$response.group[inc.physeq.data$day %in% c("35", "49", "97")] <- "late" 
inc.physeq.data <- inc.physeq.data %>%
  mutate(Treatment_Response = paste(treatment, response.group, sep = '_'))
rownames(inc.physeq.data) <- data$i_id
sample_data(inc.physeq) <- inc.physeq.data
```

```{r}
unique(inc.physeq@sam_data$treatment)
alf_7 <- subset_samples(inc.physeq, treatment %in% c("Alfalfa") & day %in% c("7")) %>%
  filter_taxa(function(x) sum(x) > 0, T)

otu.mean = apply(X = otu_table(alf_7), MARGIN = 1, mean)
otu.freq = rowSums(otu_table(alf_7) != 0)

t = data.frame(Frequency = otu.freq, 
               Mean = otu.mean,
               Total_Abundance = taxa_sums(alf_7), 
               tax_table(alf_7))
t[1:10,]
```
How about looking at high frequency OTUs? How many OTUs were detected in 8 out of 12 alfalfa microcosms on day 7?     
```{r}
nrow(alf_7)
high.freq <- t %>% 
  rownames_to_column("OTU") %>%
  filter(Frequency >= 8) 
head(high.freq)
nrow(high.freq)
```
Track relative abundance of these 795 high frequency day 7 alfalfa OTUs throughout the incubated alfalfa timeline.    
```{r}
alfalfa <- subset_samples(inc.physeq, treatment %in% c("Alfalfa"))
head(sample_data(alfalfa))
alfalfa.high.freq <- prune_taxa(high.freq$OTU, alfalfa) %>%
  filter_taxa(function(x) sum(x) > 1, T)
```

```{r}
# This will make a list of samples in the correct day order
sample.order <- as.data.frame(sample_data(alfalfa.high.freq)) %>%
  arrange(day, replication) %>%
  select(i_id) %>%
  remove_rownames() 

#abundance_heatmap_ggplot(alf.a, classification = 'Genus', treatment = c('treatment'), transformation = 'log')

plot_heatmap(alfalfa.high.freq, sample.label = "day", taxa.order = "Phylum", taxa.label = "Genus",  
                              sample.order = as.character(sample.order$i_id), 
                              low = "yellow", high = "red", na.value = "grey") 
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
