---
title: "test"
author: "Jared Flater"
date: "5/15/2019"
output:
  html_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")

BiocManager::install("ggtree")
BiocManager::install("phyloseq")
BiocManager::install("treeio")

library(reshape2)
library(tidyverse)
library(phyloseq)
library(ggtree)
library(treeio)
```
```{r, message=F, error=F, warning=F, echo=F}
tree <- read.tree("../data/tree.nwk")
inc.physeq <- readRDS("../data/RDS/incubation_physeq_Aug18.RDS")
inc <- merge_phyloseq(inc.physeq, tree)
inc <- subset_samples(inc, day %in% c("7", "14", "21", "35", "49", "97"))
inc
no.unclass <- subset_taxa(inc, !Phylum=="Bacteria_unclassified")
no.unclass <- subset_taxa(no.unclass, !Genus=="Gp6_unclassified")
inc_rare <- rarefy_even_depth(physeq = no.unclass, sample.size = 5000, rngseed = 3242343, verbose = F)
inc_rare
```

```{r, message=F, error=F, warning=F}
# too big, need smaller tree, use a phyloseq object with tree added and then only use one phyla
TopNOTUs = names(sort(taxa_sums(inc_rare), TRUE)[1:500])
inc10 <- prune_taxa(TopNOTUs, inc_rare) %>%
  filter_taxa(function(x) sum(x) >= 3, T) %>%
  transform_sample_counts(function(x) x / sum(x)) %>%
  tax_glom(taxrank = "Genus")

t1 <- phy_tree(inc10)
data <- psmelt(inc10) 
```

```{r}
cast.data <- data %>% 
  group_by(OTU, treatment) %>% 
  summarise_at('Abundance', mean) %>% 
  dcast(OTU ~ treatment) %>%
  column_to_rownames("OTU")

head(cast.data)  
```

```{r}
tax <- data.frame(tax_table(inc10)) %>%
  rownames_to_column(var = "label")
head(tax)
```
```{r}
ggtree(t1)
p <- ggtree(t1) %<+% tax +
    geom_tiplab(aes(label=Genus))
p
```
```{r}
d2 = dplyr::mutate(tax, newlab = paste(Phylum, Genus, sep='|'))
head(d2)

p <- ggtree(t1) %<+% d2 +
    geom_tiplab(aes(label=newlab), size=2, align=TRUE, linesize=.5) + theme_tree()
p

#circular plot
y <- ggtree(t1, layout = "circular") %<+% d2 %>%
    gheatmap(cast.data, offset=.7, width=0.1, font.size = 3, colnames=T, colnames_angle=-45, hjust=0) %>%
        scale_x_ggtree()
y

final_p <- p  %>%
    gheatmap(cast.data, offset=.7, width=0.1, font.size = 3, colnames=T, colnames_angle=-45, hjust=0) %>%
        scale_x_ggtree()
plot(final_p)
png("../Figures/abundance_tree.png",height=15,width=10,units='in',res=600)
plot(final_p)
dev.off()
```
                         
## Tree and heatmap of responding genera      
#### Early responders, genera from the eraly group of days compared to baseline for each treatment, the baseline comparison uses treatment and reference baseline genera (early treatment compared to baseline treatment + baseline reference). These are genera that are responding to the treatment condition and time. from each treatment. 

```{r}
early_resp_alf <- readRDS("../data/early.alf.otus.rds") %>% dplyr::rename(Early_Alfalfa = log2FoldChange, label = OTU)
early_resp_comp <- readRDS("../data/early.comp.otus.rds") %>% dplyr::rename(Early_Compost = log2FoldChange, label = OTU)
early_resp_mix <- readRDS("../data/early.mix.otus.rds") %>% dplyr::rename(Early_Mix = log2FoldChange, label = OTU)

late_resp_alf <- readRDS("../data/late.alf.otus.rds") %>% dplyr::rename(Late_Alfalfa = log2FoldChange, label = OTU)
late_resp_comp <- readRDS("../data/late.comp.otus.rds") %>% dplyr::rename(Late_Compost = log2FoldChange, label = OTU)
late_resp_mix <- readRDS("../data/late.mix.otus.rds") %>% dplyr::rename(Late_Mix = log2FoldChange, label = OTU)

all_resp <- rbind(early_resp_alf[1:3], late_resp_alf[1:3], early_resp_comp[1:3], late_resp_comp[1:3], early_resp_mix[1:3], late_resp_mix[1:3])

dist_all_resp <- distinct(all_resp)
df <- merge(early_resp_alf, dist_all_resp, all = T) %>%
  merge(late_resp_alf, all = T) %>%
  merge(early_resp_comp, all = T) %>%
  merge(late_resp_comp, all = T) %>%
  merge(early_resp_mix, all = T) %>%
  merge(late_resp_mix, all = T) 

```
```{r}
inc_resp <- prune_taxa(c(df$label), inc_rare)
inc_resp_tre <- phy_tree(inc_resp)
```

```{r}
df2 = dplyr::mutate(df, newlab = paste(Phylum, Genus, sep='|'))
head(df2)
```

```{r}
resp_p <- ggtree(inc_resp_tre) %<+% df2 +
    geom_tiplab(aes(label=newlab), size=3, align=TRUE, linesize=.5) + theme_tree()
resp_p
```
```{r}
df3 <- df %>%
  column_to_rownames("label") %>%
  select(-c(Phylum, Genus))
```
```{r, fig.height=15, fig.width=10}
final_resp <- resp_p  %>%
    gheatmap(df3, offset=1.2, width=0.5, font.size = 3, colnames=T, colnames_angle=-45, hjust=0, color = "black") 
plot(final_resp)
png("../Figures/resp_tree.png",height=16,width=13,units='in',res=600)
plot(final_resp) + scale_color_viridis(discrete = T, option = "viridis") + ggplot2::theme_bw()
dev.off()
```

