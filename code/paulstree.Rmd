---
title: "test"
author: "Jared Flater"
date: "5/15/2019"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reshape2)
library(tidyverse)
library(phyloseq)
library(ggtree)
library(treeio)
```
```{r, message=F, error=F, warning=F, echo=F}
tree <- read.tree("../data/tree.nwk")
inc.physeq <- readRDS("../data/RDS/incubation_physeq_Aug18.RDS")
inc <- merge_phyloseq(inc.physeq, tree)
inc <- subset_samples(inc, day %in% c("7", "14", "21", "35", "49", "97"))
inc
no.unclass <- subset_taxa(inc, !Phylum=="Bacteria_unclassified")
no.unclass
inc_rare <- rarefy_even_depth(physeq = no.unclass, sample.size = 5000, rngseed = 3242343, verbose = F)
inc_rare
```

```{r, message=F, error=F, warning=F}
# too big, need smaller tree, use a phyloseq object with tree added and then only use one phyla
TopNOTUs = names(sort(taxa_sums(inc_rare), TRUE)[1:1500])
inc10 <- prune_taxa(TopNOTUs, inc_rare) %>%
  filter_taxa(function(x) sum(x) >= 3, T) %>%
  transform_sample_counts(function(x) x / sum(x)) %>%
  tax_glom(taxrank = "Genus")

t1 <- phy_tree(inc10)
data <- psmelt(inc10) 
```

```{r}
cast.data <- data %>% 
  group_by(OTU, treatment) %>% 
  summarise_at('Abundance', mean) %>% 
  dcast(OTU ~ treatment) %>%
  column_to_rownames("OTU")

head(cast.data)  
```

```{r}
tax <- data.frame(tax_table(inc10)) %>%
  rownames_to_column(var = "label")
head(tax)
```
```{r}
ggtree(t1)
p <- ggtree(t1) %<+% tax +
    geom_tiplab(aes(label=Genus))
p
```
```{r}
d2 = dplyr::mutate(tax, newlab = paste(Phylum, Genus, sep='|'))
head(d2)

p <- ggtree(t1) %<+% d2 +
    geom_tiplab(aes(label=newlab), size=2, align=TRUE, linesize=.5) + theme_tree()
p

final_p <- p  %>%
    gheatmap(cast.data, offset=.7, width=0.1, font.size = 3, colnames=T, colnames_angle=-45, hjust=0) %>%
        scale_x_ggtree()
plot(final_p)
png("../Figures/abundance_tree.png",height=15,width=10,units='in',res=600)
plot(final_p)
dev.off()
```

