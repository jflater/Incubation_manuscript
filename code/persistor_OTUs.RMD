 Libraries needed
```{r, message=F}
library(phyloseq)
library(tidyverse)
library(gplots)
```

 Read in whole phyloseq object
```{r}
incubation.physeq <- readRDS("../data/RDS/incubation_physeq_Aug18.RDS")
```

 See what categories describe our treatments:
```{r}
levels(sample_data(incubation.physeq)$treatment)
```

 Function to get a list of OTUs from a sample type
```{r}
GetOTUs <- function(physeq, samples) {
    prune_samples(sample_data(physeq)$treatment %in% c(samples), physeq) %>%
    filter_taxa(function(x) sum(x) > 1, T) %>%
    tax_table() %>%
    row.names()
}
```

 Using function to generate list of OTUs from all starting soil, incubated soils and amendments
```{r}
# Incubated samples:
Alfalfa.otus <- GetOTUs(incubation.physeq, c("Alfalfa"))
Compost.otus <- GetOTUs(incubation.physeq, c("Compost"))
CompAlfa.otus <- GetOTUs(incubation.physeq, c("CompAlfa"))
Control.otus <- GetOTUs(incubation.physeq, c("Control"))
# Amendment samples:
AlfalfaAmend.otus <- GetOTUs(incubation.physeq, c("AlfalfaAmend"))
CompostAmend.otus <- GetOTUs(incubation.physeq, c("CompostAmend"))
# Soil sample:
AlfalfaSoil.otus <- GetOTUs(incubation.physeq, c("AlfalfaSoil"))
```

```{r}
GetAlienHeatMap <- function(physeq, control_otus, alien_otus, recieving_otus,samples){
  otus <- list(alien_otus, control_otus)
  venn <- venn(otus)
  alf.aliens <- attr(venn, "intersections")$A
  aliens <- list(alf.aliens, recieving_otus)
  aliens.venn <- venn(aliens)
  aliens.detected <- attr(aliens.venn,"intersections")$`A:B`
  incubated <- prune_samples(sample_data(physeq)$treatment %in% c(samples), physeq) %>%
    filter_taxa(function(x) sum(x) > 5, T) %>%
    transform_sample_counts(function(x) x / sum(x)) 
  incubated.aliens <- prune_taxa(aliens.detected, incubated)
  sample.order <- as.data.frame(sample_data(incubated.aliens)) %>%
    arrange(day, replication) %>%
    select(i_id) %>%
    remove_rownames()   
  alien.heatmap <- plot_heatmap(incubated.aliens, sample.label = "day", taxa.order= "Phylum", taxa.label = "Genus",
                                  sample.order = as.character(sample.order$i_id), 
                                  low = "#66CCFF", high = "#000033", na.value = "white")
  alien.heatmap
}
```

```{r}
alf.heatmap <- GetAlienHeatMap(incubation.physeq, Control.otus, AlfalfaAmend.otus, Alfalfa.otus, c("Alfalfa"))
comp.heatmap <- GetAlienHeatMap(incubation.physeq, Control.otus, CompostAmend.otus, Compost.otus, c("Compost"))
```
```{r}
alf.heatmap
```
```{r}
comp.heatmap
```

I didn't extract DNA from a mixed sample of compost and alfalfa, to get the list of potential aliens, we will combine the two lists from alfalfa and compost.
```{r}
mix <- c(AlfalfaAmend.otus, CompostAmend.otus)
mix.heatmap <- GetAlienHeatMap(incubation.physeq, Control.otus, mix, CompAlfa.otus, c("CompAlfa"))
mix.heatmap
```

